---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(sf)
library(leaflet)
# library(tigris)
```

downloaded tigris urban areas and places for 2018
downloaded FCC 2018 data
```{r skip1}
path <- "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/census_2013_urbanareas_places/"
options(tigris_use_cache = TRUE)
#urban_areas_2018 <- tigris::urban_areas(year = 2018)
fips <- tigris::fips_codes %>% .$state_code %>% unique
for (i in 1:length(fips)){
  print(i)
  census_places_2018 <- tigris::places(state = fips[i], year = 2018)
  saveRDS(census_places_2018, paste0(path, "census_2018_places_", fips[i], ".RDS"))
  print(paste0(path, "census_2018_places_", fips[i], ".RDS"))
}


url <- "https://www.fcc.gov/form477/BroadbandData/Fixed/Dec18/Version%202/US-Fixed-without-Satellite-Dec2018.zip"
temp <- tempfile()
download.file(url,temp)
unlink(temp)

# grab temp pathname and go intoto terminal 
# ran this to see name of file in zip 
# unzip -l /tmp/RtmpSdiLsM/file360be78486be5
# ran this to unzip from terminal:
# unzip /tmp/RtmpSdiLsM/file360be78486be5 -d /project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/

# fcc_2018 <- read.csv("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fbd_us_without_satellite_dec2018_v2.csv")
# 
# fcc_2018_block_max <- fcc_2018 %>%
#   group_by(StateAbbr, BlockCode) %>%
#   summarise(MaxAdDown_ = max(MaxAdDown),
#             MaxAdUp_ = max(MaxAdUp)) %>%
#   mutate(speed_elig_down = ifelse(MaxAdDown_ >= 10, 0, 1),
#          speed_elig_up = ifelse(MaxAdUp_ >= 1, 0, 1),
#          speed_inelig = ifelse(MaxAdDown_ >= 10 & MaxAdUp_ >= 1, 1, 0),
#          speed_elig = ifelse(MaxAdDown_ >= 10 & MaxAdUp_ >= 1, 0, 1))
# 
# saveRDS(fcc_2018_block_max, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fcc_2018_block_maxspdelig.RDS")

```

read in tigris urban areas and places for 2018
```{r run0}
## RURALITY 
# path <- "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/census_2018_urbanareas_places/"
# rurality_files <- list.files(path)
# urbanareas2018 <- readRDS(paste0(path, rurality_files[57]))
# rurality_files <- rurality_files[1:56]
# rurality_files <- paste0(path, rurality_files)
# data_l <- as.list(rurality_files)
# shps <- lapply(data_l, function(x) readRDS(x))
# shps_e <- do.call(rbind, shps)

savepath <- "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RECONNECT_NON_RURAL_working/"
savepath_1 <- "blocks_nonruralTF_df/"
files = list.files(paste0(savepath, savepath_1))
paths = paste0(savepath, savepath_1, files)
states = stringr::str_extract(files, "\\d{2}(?=.RDS)")

fips <- tigris::fips_codes %>% select(state, state_code) %>% distinct()

nonrurality_statefiles <- data.frame(states = states, files = files, paths = paths) %>% 
  left_join(fips, by = c("states" = "state_code"))

shps <- lapply(nonrurality_statefiles$paths, FUN = readRDS)
shps_col <- lapply(shps, FUN = ncol) %>% unlist

# for (i in 1:length(shps_col)) {
#   print(i)
#   if(shps_col[i] > 18) {
#     shps[[i]] <- shps[[i]] %>% select(-COUNTYFP, -STATEFP)
#   }
# }

# shps_col <- lapply(shps, FUN = ncol) %>% unlist

shps_e <- do.call(rbind, shps)
# saveRDS(shps_e, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RECONNECT_NON_RURAL_working/final_nonruralareas_USDAfile_translatedblocks_df_NOV182020.RDS")

shps_e <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RECONNECT_NON_RURAL_working/final_nonruralareas_USDAfile_translatedblocks_df_NOV182020.RDS")
## CENSUS

### clean environment
rm(rurality_files, data_l, shps)
```

get population per census places in 2010
```{r run1 }
# Sys.setenv("ed8973afe8a22958b77ffdb8547c93c3cae1d2fc")
# tidycensus::census_api_key("ed8973afe8a22958b77ffdb8547c93c3cae1d2fc") 
# us_pop_2010 <- tidycensus::get_decennial(geography="place", variables="P001001", 
#                                          year=2010,  cache_table=TRUE)

```

```{r}
fcc_2018_block_max <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fcc_2018_block_maxspdelig.RDS")
```


```{r run3}
fips  <- tigris::fips_codes 
fips_ <- fips %>% select(state, state_code) %>% distinct()

# geo_folder <- "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS/"
# geo_paths <- list.files(geo_folder)
# 
# geo_paths <- data.frame(files = geo_paths) %>% mutate(state = stringr::str_remove_all(files, "tl_2018_|_tabblock10.RDS$"))
# 
# geo_paths <- geo_paths %>% 
#   left_join(fips_, by = c("state" = "state_code")) %>% 
#   transmute(state = state.y, state_fips = state, files, paths = paste0(geo_folder, files))
# 
# data_l <- as.list(geo_paths$paths)
# shapes <- lapply(data_l, function(x) readRDS(x))
# shapes_e <- do.call(rbind, shapes)

# saveRDS(shapes, "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_LIST.RDS")

# shapes <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_LIST.RDS")

# saveRDS(shapes_e, "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_SF.RDS")

# shapes_e  <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_SF.RDS")
shapes_e <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_SF_wmissing.RDS")


```


```{r run4}
fcc_2018_block_max$BlockCode <- as.character(fcc_2018_block_max$BlockCode)
fcc_2018_block_max <- fcc_2018_block_max %>% mutate(BlockCode2 = ifelse(nchar(BlockCode) == 14, paste0("0", BlockCode), BlockCode))

shapes_e_fcc <- shapes_e %>% 
  mutate(FULL_GEOID = paste0(STATEFP10, COUNTYFP10, TRACTCE10, BLOCKCE10)) %>% 
  left_join(fcc_2018_block_max, by = c("FULL_GEOID" = "BlockCode2")) %>% 
  left_join(fips_, by = c("STATEFP10" = "state_code"))

joinbystate_res <- shapes_e_fcc %>% as.data.frame() %>% count(state, speed_elig)
fcccehckbystate_res <- fcc_2018_block_max %>% count(StateAbbr, speed_elig) 

joinbystate_res
joinbystate_res %>% select(-n) %>% count(state) 
fcccehckbystate_res
```

## Filter rurality datasets by population 

```{r run5}
# rurality_places <- shps_e %>% 
#   transmute(SET = "places", GEOID10 = GEOID, 
#                                   NAME10 = NAME, NAMELSAD10 = NAMELSAD, 
#                                   LSAD10 = LSAD, geometry)
# 
# rurality_areas <- urbanareas2018 %>% 
#   transmute(SET = "areas", GEOID10, NAME10, 
#                                   NAMELSAD10, LSAD10, geometry)
# 
# rurality_USA <- rbind(rurality_places, rurality_areas) %>% left_join(us_pop_2010, by = c("GEOID10" = "GEOID"))
# 
# rurality_USA_elig_dontuse <- rurality_USA %>% filter(value < 20000)
# rurality_USA_inelig <- rurality_USA %>% filter(SET == "areas" | value >= 20000)  

table(shps_e$nonruralTF)

head(shps_e, 1)

blocks_rurality_TF <- shps_e %>% as.data.frame() %>% select(GEOID10, nonruralTF)
  
```

intersect - does eligible block by speed contain any urban area?
intersection - what area of eligible block by speed contains any urban area?

intersect no longer  needed, left join only - 192



```{r run6}


# fcc_2018_USA_elig <- shapes_e_fcc %>% filter(speed_elig == 1)
# fcc_2018_USA_inelig <- shapes_e_fcc %>% filter(speed_elig != 1)
# 
# #fcc_2018_USA_elig %>% nrow()
# #fcc_2018_USA_inelig %>% nrow()
# 
# #### ST INTERSECT 
# fcc_2018_USA_inelig_by_rurality_VECTOR <- st_intersects(fcc_2018_USA_elig, rurality_USA_inelig) 
# #### ST INTERSECTION 
# # fcc_2018_inelig_by_rurality_SHAPES <- st_intersection(fcc_2017_USA_elig, rurality_USA_inelig)
# 
# 
#  ###
# # fcc_2018_USA_inelig_by_rurality_VECTOR <- readRDS("~/fcc_2018_USA_inelig_by_rurality_VECTOR_03SEPT2020.RDS")
# # ###fcc_2018_inelig_by_rurality_SHAPES <- readRDS("~/fcc_2018_USA_inelig_by_rurality_SHAPES_03SEPT2020.RDS")
#  ###
# 
# 
# # saveRDS(fcc_2018_USA_inelig_by_rurality_VECTOR, "~/fcc_2018_USA_inelig_by_rurality_VECTOR_17SEPT2020.RDS")
# 
# fcc_2018_USA_elig$rural_inelg_vec <- fcc_2018_USA_inelig_by_rurality_VECTOR %>% lengths >0 

usa_blocks_speed_rural %>% head(1000) %>% as.data.frame() %>% mutate

fcc_2018_USA_elig <- fcc_2018_USA_elig  %>% mutate(disqualification = ifelse(rural_inelg_vec == TRUE, "rural only", "not disqual by speed/rural"))
fcc_2018_USA_inelig <- fcc_2018_USA_inelig %>% mutate(rural_inelg_vec = NA, disqualification = "speed only")

USA_speed_rural_criteria_2018 <- rbind(fcc_2018_USA_elig, fcc_2018_USA_inelig)

table(USA_speed_rural_criteria_2018$disqualification, useNA = "ifany")
table(USA_speed_rural_criteria_2018$rural_inelg_vec, useNA = "always")

fcc_2018_USA_inelig_by_rurality_VECTOR <- readRDS("~/fcc_2018_USA_inelig_by_rurality_VECTOR_17SEPT2020.RDS")

# saveRDS(USA_speed_rural_criteria_2018, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_speed_urban_criteria_eligibility_RES_17SEPT2020.RDS")

USA_speed_rural_criteria_2018 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_speed_urban_criteria_eligibility_RES_17SEPT2020.RDS")


```

```{r}
rm(fcc_2018_block_max, fips, fips_, rurality_areas, rurality_places, rurality_USA, shapes_e_fcc, shps_e, urbanareas2018, us_pop_2010)
```

```{r}
usa_blocks_speed_rural <- shapes_e_fcc %>% left_join(blocks_rurality_TF, by = c("GEOID10"))
# table(usa_blocks_speed_rural$speed_elig, useNA = "ifany")

#### PROT BORR
protborr <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/rus_broadband_servicearea/ProtectedBorrowers04222019.shp")
protborr <- protborr %>% st_transform(st_crs(usa_blocks_speed_rural))
blocks_criteriaXprotborr_VECTOR <- st_intersects(usa_blocks_speed_rural, protborr) 
usa_blocks_speed_rural$protborr_inelg_vec <- blocks_criteriaXprotborr_VECTOR %>% lengths >0 

#### CAF II
caf2auctionwinners <- st_read("/project/biocomplexity/sdad/projects_data/usda/bb/original/Protected_bb_borrower_service_areas/Auction903_April2019.shp")
caf2auctionwinners <- caf2auctionwinners %>% st_transform(st_crs(usa_blocks_speed_rural))
blocks_criteriaXcaf2winners_VECTOR <- st_intersects(usa_blocks_speed_rural, caf2auctionwinners) 
usa_blocks_speed_rural$caf2_inelg_vec <- blocks_criteriaXcaf2winners_VECTOR %>% lengths >0 

usa_blocks_speed_rural_projects_final_2018 <- usa_blocks_speed_rural %>% 
  mutate(disqual1 = ifelse(speed_inelig != 1|is.na(speed_inelig), "eligible", "speed")) %>%
  mutate(disqual2 = ifelse(nonruralTF != 1|is.na(nonruralTF), "eligible", "nonrural")) %>%
  mutate(disqual3 = ifelse(protborr_inelg_vec == TRUE|caf2_inelg_vec == TRUE, "projects", "eligible")) %>%
  mutate(eligibility_final = ifelse(stringr::str_count(paste(disqual1, disqual2, disqual3), pattern = "eligible")> 0, "ineligible", "eligible" ))
  
table(usa_blocks_speed_rural_projects_final_2018$eligibility_final)
table(usa_blocks_speed_rural$speed_inelig, useNA = "ifany")
table(usa_blocks_speed_rural$nonruralTF, useNA = "ifany")
table(usa_blocks_speed_rural$protborr_inelg_vec, useNA = "ifany")
table(usa_blocks_speed_rural$caf2_inelg_vec, useNA = "ifany")

usa_blocks_speed_rural_projects_final_2018 %>% 
  count(disqual1, disqual2, disqual3)

```


Now trying to get Intersects - B - census blocks that do not appear in FCC data 
these need to be intersected against rural files

```{r intersectB}
shapes_e  <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_SF.RDS")

USA_speed_rural_criteria_2018 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_speed_urban_criteria_eligibility_RES_17SEPT2020.RDS")

block_IDs_not_listed_in_fcc <- setdiff(shapes_e$GEOID10, USA_speed_rural_criteria_2018$FULL_GEOID)

shapes_not_listed_in_fcc <- shapes_e %>% filter(GEOID10 %in% block_IDs_not_listed_in_fcc)

#### ST INTERSECT 
census_missing_2018_USA_inelig_by_rurality_VECTOR <- st_intersects(shapes_not_listed_in_fcc, rurality_USA_inelig) 

shapes_not_listed_in_fcc$rural_inelg_vec <- census_missing_2018_USA_inelig_by_rurality_VECTOR %>% lengths >0 

shapes_not_listed_in_fcc <- shapes_not_listed_in_fcc  %>% mutate(disqualification = ifelse(rural_inelg_vec == TRUE, "rural only, not in fcc", "not disqual by speed/rural"))

table(shapes_not_listed_in_fcc$rural_inelg_vec)
table(shapes_not_listed_in_fcc$disqualification)

saveRDS(shapes_not_listed_in_fcc, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_censusmissing_speed_urban_criteria_eligibility_RES_17SEPT2020.RDS")

USA_speed_rural_criteria_2018_censusblocks <- rbind(USA_speed_rural_criteria_2018, 
                                                    shapes_not_listed_in_fcc %>% 
                                                      mutate(FULL_GEOID = NA,
                                                             StateAbbr = NA,
                                                             BlockCode = NA, 
                                                             MaxAdDown_ = NA,
                                                             MaxAdUp_ = NA, 
                                                             speed_elig_down = NA,
                                                             speed_elig_up = NA,
                                                             speed_inelig = NA,
                                                             speed_elig = NA,
                                                             state = NA
                                                             ))

saveRDS(USA_speed_rural_criteria_2018_censusblocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_FULLSET_speed_urban_criteria_eligibility_RES_17SEPT2020.RDS")

```



```{r existingprojects}
USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_FULLSET_speed_urban_criteria_eligibility_RES_17SEPT2020.RDS")

protborr <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/rus_broadband_servicearea/ProtectedBorrowers04222019.shp")

protborr <- protborr %>% st_transform(st_crs(USA_speed_rural_criteria_2018_censusblocks))

#### ST INTERSECT 
blocks_criteriaXprotborr_VECTOR <- st_intersects(USA_speed_rural_criteria_2018_censusblocks, protborr) 

USA_speed_rural_criteria_2018_censusblocks$protborr_inelg_vec <- blocks_criteriaXprotborr_VECTOR %>% lengths >0 

table(USA_speed_rural_criteria_2018_censusblocks$disqualification, USA_speed_rural_criteria_2018_censusblocks$protborr_inelg_vec)

USA_speed_rural_criteria_2018_censusblocks <- USA_speed_rural_criteria_2018_censusblocks %>% 
  mutate(disqualification2 = 
           ifelse(disqualification == "not disqual by speed/rural" & protborr_inelg_vec == TRUE, "prot borr only", 
                  ifelse(disqualification == "rural only" &  protborr_inelg_vec == TRUE, "rural + prot borr", 
                         ifelse(disqualification == "rural only, not in fcc" & protborr_inelg_vec == TRUE, "rural only not in FCC + prot borr",
                                ifelse(disqualification == "speed only" & protborr_inelg_vec == TRUE, "speed + prot borr", disqualification)))))


table(USA_speed_rural_criteria_2018_censusblocks$disqualification2)

# saveRDS(USA_speed_rural_criteria_2018_censusblocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_FULLSET_protborrs_speed_urban_criteria_eligibility_RES_21SEPT2020.RDS")

caf2auctionwinners <- st_read("/project/biocomplexity/sdad/projects_data/usda/bb/original/Protected_bb_borrower_service_areas/Auction903_April2019.shp")

caf2auctionwinners <- caf2auctionwinners %>% st_transform(st_crs(USA_speed_rural_criteria_2018_censusblocks))

#### ST INTERSECT 
blocks_criteriaXcaf2winners_VECTOR <- st_intersects(USA_speed_rural_criteria_2018_censusblocks, caf2auctionwinners) 

USA_speed_rural_criteria_2018_censusblocks$caf2_inelg_vec <- blocks_criteriaXcaf2winners_VECTOR %>% lengths >0 

table(USA_speed_rural_criteria_2018_censusblocks$disqualification2, USA_speed_rural_criteria_2018_censusblocks$caf2_inelg_vec)

USA_speed_rural_criteria_2018_censusblocks  <- USA_speed_rural_criteria_2018_censusblocks %>%
  mutate(disqualification3 = ifelse(caf2_inelg_vec == TRUE, 
                            ifelse(disqualification2 != "not disqual by speed/rural", 
                                   paste0(disqualification2, " + caf2"), 
                                   "caf2 only"), 
                            disqualification2))

table(USA_speed_rural_criteria_2018_censusblocks$disqualification3)

saveRDS(USA_speed_rural_criteria_2018_censusblocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_FULLCRITERIA_speed_urban_criteria_eligibility_RES_21SEPT2020.RDS")

```

Protected Borrowers does not have ReConnect projects

```{r}
# protborr %>% head()
# table(protborr$PROGRAM)
# table(protborr$SUBPROGRAM)
# table(protborr$INF)
# table(protborr$BB)
# table(protborr$BIPLOAN)
# table(protborr$BIPGRANT)
# table(protborr$CCGRANT)
```


```{r perc_eligibility_byblock}
USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_FULLCRITERIA_speed_urban_criteria_eligibility_RES_21SEPT2020.RDS")

USA_speed_rural_criteria_2018_censusblocks_missing <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_FULLCRITERIA_speed_urban_criteria_eligibility_RES_missingstates_23SEPT2020.RDS")

# savepath <- "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/"


# setdiff(colnames(USA_speed_rural_criteria_2018_censusblocks_missing), colnames(USA_speed_rural_criteria_2018_censusblocks))
# 
# checks <- USA_speed_rural_criteria_2018_censusblocks_missing %>% transmute(check1 = ifelse(STATEFP == STATEFP10, 1, 0),
#                                                               check2 = ifelse(COUNTYFP == COUNTYFP10, 1, 0))
# table(checks$check1, useNA = "ifany")
# table(checks$check2, useNA = "ifany")

USA_speed_rural_criteria_2018_censusblocks <- rbind(USA_speed_rural_criteria_2018_censusblocks, USA_speed_rural_criteria_2018_censusblocks_missing %>% select(-STATEFP, -COUNTYFP))

saveRDS(USA_speed_rural_criteria_2018_censusblocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_23SEPT2020.RDS")

```

```{r}
USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_23SEPT2020.RDS")

duplicatedmissing <- c("11", "15", "33", "42", "44", "48", "69")

dupe_missing <- USA_speed_rural_criteria_2018_censusblocks %>% filter(STATEFP10 %in% duplicatedmissing)
not_dupe_missing <- USA_speed_rural_criteria_2018_censusblocks %>% filter(STATEFP10 %in% duplicatedmissing == FALSE)

dupe_missing_69 <- dupe_missing %>% filter(STATEFP10 == "69") %>% slice(1:1444)
dupe_missing_48 <- dupe_missing %>% filter(STATEFP10 == "48") %>% slice(1:914231)
dupe_missing_44 <- dupe_missing %>% filter(STATEFP10 == "44") %>% slice(1:25181)
dupe_missing_42 <- dupe_missing %>% filter(STATEFP10 == "42") %>% slice(1:421545)
dupe_missing_33 <- dupe_missing %>% filter(STATEFP10 == "33") %>% slice(1:48837)
dupe_missing_15 <- dupe_missing %>% filter(STATEFP10 == "15") %>% slice(1:25016)
dupe_missing_11 <- dupe_missing %>% filter(STATEFP10 == "11") %>% slice(1:6507)


USA_speed_rural_criteria_2018_censusblocks_ <- rbind(not_dupe_missing, dupe_missing_11, dupe_missing_15, dupe_missing_33, dupe_missing_42, dupe_missing_44, dupe_missing_48, dupe_missing_69)

# saveRDS(USA_speed_rural_criteria_2018_censusblocks_, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_21OCT2020.RDS")

USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_21OCT2020.RDS")


```


```{r}
USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_21OCT2020.RDS")
```



```{r}
savepath <- "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/"

tract_summary <- USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(STATEFP10, COUNTYFP10, TRACTCE10, disqualification3) %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  select(-disqualification3) %>% 
  group_by(STATEFP10, COUNTYFP10, TRACTCE10, eligibility) %>%
  summarise(sum = sum(n)) %>% 
  reshape2::dcast(STATEFP10 + COUNTYFP10 + TRACTCE10 ~ eligibility, sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(tract_summary$PERC_ELIGIBLE)
table(tract_summary$PERC_ELIGIBLE == 0)
18194/nrow(tract_summary) # FALSE = ELIGIBLE
54963/nrow(tract_summary) # TRUE = INELIGIBLE

# saveRDS(tract_summary, paste0(savepath, "2018_tract_summary_blockct_perc_elig", "_OCT21_2020", ".RDS"))

county_summary <- USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(STATEFP10, COUNTYFP10, disqualification3) %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  select(-disqualification3) %>% 
  group_by(STATEFP10, COUNTYFP10, eligibility) %>%
  summarise(sum = sum(n)) %>% 
  reshape2::dcast(STATEFP10 + COUNTYFP10 ~ eligibility, sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(county_summary$PERC_ELIGIBLE)
table(county_summary$PERC_ELIGIBLE == 0)
2770/nrow(county_summary)  # FALSE = ELIGIBLE
383/nrow(county_summary) # TRUE = INELIGIBLE

# saveRDS(county_summary, paste0(savepath, "2018_county_summary_blockct_perc_elig", "_OCT21_2020", ".RDS"))

state_summary <- USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(STATEFP10, disqualification3) %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  select(-disqualification3) %>% 
  group_by(STATEFP10, eligibility) %>%
  summarise(sum = sum(n)) %>% 
  reshape2::dcast(STATEFP10 ~ eligibility, sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(state_summary$PERC_ELIGIBLE)
table(state_summary$PERC_ELIGIBLE == 0)
53/nrow(state_summary) # FALSE = ELIGIBLE
1/nrow(state_summary) # TRUE = INELIGIBLE

# saveRDS(state_summary, paste0(savepath, "2018_state_summary_block_ct_perc_elig", "_OCT21_2020", ".RDS"))

library(ggplot2)
state_summary <- state_summary %>% 
  left_join(fips_, by = c("STATEFP10" = "state_code"))
state_summary <- state_summary %>% 
  mutate(PERC_ELIGIBLE__ = paste0(100*(as.numeric(format(PERC_ELIGIBLE, digits = 1))), "%"))
ggplot(state_summary, aes(x = reorder(state, -PERC_ELIGIBLE), y = PERC_ELIGIBLE)) + 
  geom_bar(stat = "identity") + 
  geom_text(stat = "identity", aes(label = reorder(PERC_ELIGIBLE__, -PERC_ELIGIBLE), hjust=0.5, vjust = -1)) + 
  labs(title = "Percent Eligibility - States") + 
  xlab(label = "State Abbreviation") + 
  ylab(label = "Percent Eligibility (% by # blocks)")



fips_ %>% filter(state_code %in% setdiff(fips_$state_code, state_summary$STATEFP10)) %>% left_join(fips %>% select(state_code, state_name) %>% distinct(), by = "state_code")
fips %>% select(state, state_name) %>% distinct()
# deprioritize - DC, Hawaii, Puerto Rico, MP - Mauriana Islands , UM - US Minor Outlying Islands, VI - Virgin Islansds
# problems - Pennsylvania, New Hampshire, Rhode Island, Texas

table(USA_speed_rural_criteria_2018_censusblocks$state)
fips_ %>% filter(state_code %in% setdiff(fips_$state, fcc_2018_block_max$StateAbbr))
unique(fcc_2018_block_max$StateAbbr)

fips_ %>% filter(state_code %in% setdiff(fips_$state_code, shapes_e$STATEFP10))



```


```{r perc_eligibility_byarea}

USA_speed_rural_criteria_2018_censusblocks <- USA_speed_rural_criteria_2018_censusblocks %>% mutate(blockarea = st_area(geometry))

# saveRDS(USA_speed_rural_criteria_2018_censusblocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_wArea_21OCT2020.RDS")

tract_summary2 <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  group_by(STATEFP10, COUNTYFP10, TRACTCE10, eligibility) %>% 
  summarise(area = as.numeric(blockarea))  %>%
  reshape2::dcast(STATEFP10 + COUNTYFP10 + TRACTCE10 ~ eligibility, value.var = "area", fun.aggregate = sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(tract_summary$PERC_ELIGIBLE)
table(tract_summary$PERC_ELIGIBLE == 0)
table(tract_summary$PERC_ELIGIBLE == 0)/nrow(tract_summary)  # FALSE = ELIGIBLE  # TRUE = INELIGIBLE



# saveRDS(tract_summary2, paste0(savepath, "2018_tract_summary_area_perc_elig", "_OCT21_2020", ".RDS"))
```

```{r}
compare <- tract_summary %>% 
  left_join(tract_summary2, by = c("STATEFP10", "COUNTYFP10", "TRACTCE10")) 
  
compare %>% select(1:3, ELIGIBLE.x, ELIGIBLE.y, Total.x, Total.y)
compare %>% select(1:3, ELIGIBLE.x, ELIGIBLE.y, PERC_ELIGIBLE.x, PERC_ELIGIBLE.y)

compare %>% transmute(diff = PERC_ELIGIBLE.x - PERC_ELIGIBLE.y) %>% .$diff %>% hist
fips %>% select(state, state_name) %>% distinct()

```



```{r}
county_summary <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  group_by(STATEFP10, COUNTYFP10, eligibility) %>% 
  summarise(area = as.numeric(blockarea))  %>%
  reshape2::dcast(STATEFP10 + COUNTYFP10 ~ eligibility, value.var = "area", fun.aggregate = sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(county_summary$PERC_ELIGIBLE)
table(county_summary$PERC_ELIGIBLE == 0)
table(county_summary$PERC_ELIGIBLE == 0)/nrow(county_summary)  # FALSE = ELIGIBLE  # TRUE = INELIGIBLE

# saveRDS(county_summary, paste0(savepath, "2018_county_summary_area_perc_elig", "_OCT21_2020", ".RDS"))

```


```{r}
state_summary <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  group_by(STATEFP10, eligibility) %>% 
  summarise(area = as.numeric(blockarea))  %>%
  reshape2::dcast(STATEFP10  ~ eligibility, value.var = "area", fun.aggregate = sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(state_summary$PERC_ELIGIBLE)
table(state_summary$PERC_ELIGIBLE == 0)
table(state_summary$PERC_ELIGIBLE == 0)/nrow(state_summary)  # FALSE = ELIGIBLE  # TRUE = INELIGIBLE

# saveRDS(state_summary, paste0(savepath, "2018_state_summary_area_perc_elig", "_OCT21_2020", ".RDS"))
```

```{r}
state_summary <- state_summary %>% 
  left_join(fips_, by = c("STATEFP10" = "state_code"))
state_summary <- state_summary %>% 
  mutate(PERC_ELIGIBLE__ = paste0(100*(as.numeric(format(PERC_ELIGIBLE, digits = 1))), "%"))
ggplot(state_summary, aes(x = reorder(state, -PERC_ELIGIBLE), y = PERC_ELIGIBLE)) + 
  geom_bar(stat = "identity") + 
  geom_text(stat = "identity", aes(label = reorder(PERC_ELIGIBLE__, -PERC_ELIGIBLE), hjust=0.5, vjust = -1)) + 
  labs(title = "Percent Eligibility - States") + 
  xlab(label = "State Abbreviation") + 
  ylab(label = "Percent Eligibility (% by area)")

```


         
##################


```{r }
fcc_2018_USA_elig_remainedeligGEOIDs <- setdiff(fcc_2018_USA_elig$FULL_GEOID, fcc_2018_inelig_by_rurality_SHAPES$GEOID10) 
fcc_2018_USA_elig_remained_eligible <- fcc_2018_USA_elig %>% filter(FULL_GEOID %in% fcc_2018_USA_elig_remainedeligGEOIDs)
```


```{r}
# nrow(shapes_e) #9,641,551
nrow(shapes_e_fcc) #9,641,551 # ALL BLOCKS IN USA
nrow(shapes_e_fcc %>% filter(is.na(speed_elig))) # 1,758,186 # BLOCKS NOT LISTED IN FCC - need to be checked against rurality
nrow(shapes_e_fcc %>% filter(!is.na(speed_elig))) # 7,883,365 # BLOCKS LISTED IN FCC
nrow(fcc_2018_USA_inelig) #7,262,646 # INELIGIBLE BLOCKS BY SPEED
nrow(fcc_2018_USA_elig) #620,719 #POTENTIALLY ELIGIBLE BY SPEED, then checked against rurality
nrow(fcc_2018_inelig_by_rurality_SHAPES) #260,352 # INELIGIBLE BY RURALITY (was eligible by speed)
nrow(fcc_2018_USA_elig_remained_eligible) #453,645 # ELIGIBLE BY SPEED AND RURALITY



```


```{r}
fcc_2017_51059_inelig_by_rurality_SHAPES <- fcc_2017_51059_inelig_by_rurality_SHAPES %>% mutate(area = st_area(geometry))
USA_2017_RESelig_RnA <- USA_2017_RESelig_RnA %>% mutate(overlap_area = sf::st_area(geometry)) 

shapes_e <- shapes_e %>% mutate(block_area = sf::st_area(geometry)) 


```

```{r}
USA_2018_RESelig_RnA <- rbind(fcc_2018_USA_elig, fcc_2018_USA_inelig %>% mutate(rural_inel = 99))
```






```{r}
fcc_2018_USA_elig <- shapes_e_fcc %>% filter(speed_elig == 1)
fcc_2018_USA_inelig <- shapes_e_fcc %>% filter(speed_elig != 1)

#### ST INTERSECT 
fcc_2018_USA_inelig_by_rurality_VECTOR <- st_intersects(fcc_2018_USA_elig, rurality_USA_inelig) 
#### ST INTERSECTION 
fcc_2018_inelig_by_rurality_SHAPES <- st_intersection(fcc_2017_USA_elig, rurality_USA_inelig)

fcc_2018_USA_elig$rural_inel <- lengths(fcc_2017_USA_inelig_by_rurality_VECTOR)
# fcc_2017_USA_inelig_by_rurality_DF <- fcc_2017_USA_elig %>% filter(rural_inel != 0)

# USA_2017_inelig_RnA <- rbind(fcc_2017_USA_inelig_by_rurality_DF, fcc_2017_USA_inelig %>% mutate(rural_inel = 99))
USA_2018_RESelig_RnA <- rbind(fcc_2018_USA_elig, fcc_2018_USA_inelig %>% mutate(rural_inel = 99))



# saveRDS(USA_2017_RESelig_RnA, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_eligibility_RES_24AUG2020.RDS")
USA_2017_RESelig_RnA <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_eligibility_RES_24AUG2020.RDS")

fcc_2017_51059_inelig_by_rurality_SHAPES <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_eligibility_RES_01SEPT2020_pregeofilt.RDS")



# fcc_2017_51059_inelig_by_rurality_SHAPES %>% saveRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_eligibility_RES_SHP_27AUG2020.RDS")

```

The majority of the blocks overlap 100% (226K blocks), meaning they're completely ineligible by area. 
Some overlap partially (33K blocks), meaning they're partially eligible by area.
    * However, of these 33K blocks, 30K of them have an overlap area of 0 meters squared.
    * 3K blocks have an actual overlap area

```{r}
fcc_2017_inelig_by_rurality_SHAPES <- readRDS("~/fcc_2018_USA_inelig_by_rurality_SHAPES_03SEPT2020.RDS")
shapes_e  <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_SF.RDS") %>% mutate(block_geo =sf::st_geometry_type(geometry), block_area = sf::st_area(geometry))

fcc_2017_inelig_by_rurality_SHAPES <- fcc_2017_inelig_by_rurality_SHAPES %>% mutate(intersect_geo =sf::st_geometry_type(geometry), intersection_area = sf::st_area(geometry))

comp_area <- left_join(as.data.frame(shapes_e), as.data.frame(fcc_2017_inelig_by_rurality_SHAPES), by = c("GEOID10" = "FULL_GEOID"))
comp_area1 <- comp_area %>% select(GEOID10, block_geo, block_area, intersect_geo, intersection_area)
comp_area1 <- comp_area1 %>% mutate(area_diff = as.numeric(block_area) - as.numeric(intersection_area), 
                                    check = ifelse(is.na(intersect_geo), "none", "intersection"))

comp_area1 %>% filter(check == "none") %>% nrow() #9,474,477
comp_area1 %>% filter(check == "intersection") %>% nrow() #260,352

comp_area1 %>% filter(check == "intersection") %>% filter(area_diff == 0) #226K
comp_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0) #33K
comp_area1 <-comp_area1 %>% mutate(perc_inelig_area = as.numeric(intersection_area)/as.numeric(block_area))
comp_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0) %>% .$perc_inelig_area %>% hist
comp_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0) %>% mutate(perc_inelig_area1 = scales::comma(perc_inelig_area, accuracy = 0.1)) %>% .$perc_inelig_area1 %>% as.numeric  %>% hist

comp_area1 %>% filter(check == "intersection") %>% filter(area_diff == 0) %>% .$perc_inelig_area %>% table #226K
comp_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0)  %>% filter(perc_inelig_area == 0) #30K
comp_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0)  %>% filter(perc_inelig_area != 0) #3K
comp_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0)  %>% filter(perc_inelig_area != 0) %>% .$perc_inelig_area %>% hist

comp_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0)  %>% filter(perc_inelig_area != 0) %>% .$intersect_geo %>% table

# saveRDS(comp_area1, "~/fcc_2018_USA_inelig_by_rurality_SHAPES_areadiff_16SEPT2020.RDS")

```


```{r}
compare_area <- left_join(as.data.frame(fcc_2017_inelig_by_rurality_SHAPES), as.data.frame(shapes_e), by = c("FULL_GEOID" = "GEOID10"))
compare_area1 <- compare_area %>% select(GEOID10, block_geo, block_area, intersect_geo, intersection_area)
compare_area1 <- compare_area1 %>% mutate(area_diff = as.numeric(block_area) - as.numeric(intersection_area), 
                                    check = ifelse(is.na(intersect_geo), "none", "intersection"))

compare_area1 %>% filter(check == "none") %>% nrow() #0
compare_area1 %>% filter(check == "intersection") %>% nrow() #260,352

compare_area1 %>% filter(check == "intersection") %>% filter(area_diff == 0) #226K
compare_area1 %>% filter(check == "intersection") %>% filter(area_diff != 0) #33K

dupe_intersection_GEOIDs <- as.data.frame(fcc_2017_inelig_by_rurality_SHAPES) %>% count(FULL_GEOID) %>% filter(n > 1)

fcc_2017_inelig_by_rurality_SHAPES %>% filter(FULL_GEOID == "010150002001006")
compare_area1 %>% filter(GEOID10 == "010150002001006")
lookatduplicatedblockintersections <- compare_area1 %>% filter(GEOID10 %in% dupe_intersection_GEOIDs$FULL_GEOID) %>% count(GEOID10, area_diff) 
dupeblockintersectionIDS<- lookatduplicatedblockintersections %>% filter(n  < 2) %>% .$GEOID10 %>% unique
compare_area %>% filter(GEOID10 %in% dupeblockintersectionIDS) %>% arrange(GEOID10)
```


###################

Missing states

```{r}
# missing_states <- c("11", "15", "33", "42", "44", "48", "69", "72", "74", "78")
# texas <- tigris::blocks(state = missing_states[6])
# # saveRDS(texas, "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2019_48_tabblock10.RDS")
# rm(state)
# gc()
# state <- tigris::blocks(state = missing_states[10], year = 2018) # 8-10 didn't work
# saveRDS(state, "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_69_tabblock10.RDS")

paths <- c("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_11_tabblock10.RDS", 
           "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_15_tabblock10.RDS",
           "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_33_tabblock10.RDS",
           "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_42_tabblock10.RDS",
           "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_44_tabblock10.RDS",
           "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_48_tabblock10.RDS",
           "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/tl_2018_69_tabblock10.RDS"
           )

data_l <- as.list(paths)
shapes <- lapply(data_l, function(x) readRDS(x))
shapes_e_missing <- do.call(rbind, shapes)

rm(paths, data_l, shapes)
gc()


#### block - run4

shapes_e_fcc <- shapes_e_missing %>% 
  mutate(FULL_GEOID = paste0(STATEFP10, COUNTYFP10, TRACTCE10, BLOCKCE10)) %>% 
  left_join(fcc_2018_block_max, by = c("FULL_GEOID" = "BlockCode2")) %>% 
  left_join(fips_, by = c("STATEFP10" = "state_code"))

#### block - intersectB

block_IDs_not_listed_in_fcc <- setdiff(shapes_e_missing$GEOID10, USA_speed_rural_criteria_2018$FULL_GEOID)

shapes_not_listed_in_fcc <- shapes_e_missing %>% filter(GEOID10 %in% block_IDs_not_listed_in_fcc)

# check intersectB
nrow(USA_speed_rural_criteria_2018_censusblocks)
nrow(shapes_e_missing)

#### block - existing projects

saveRDS(USA_speed_rural_criteria_2018_censusblocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_FULLCRITERIA_speed_urban_criteria_eligibility_RES_missingstates_23SEPT2020.RDS")

```

```{r overall_eligibility table}

USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_23SEPT2020.RDS")

table(USA_speed_rural_criteria_2018_censusblocks$disqualification3)
nrow(USA_speed_rural_criteria_2018_censusblocks)

```



```{r cc_perc_eligibility_bloctct }
USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_wArea_21OCT2020.RDS")

# USA_speed_rural_criteria_2018_censusblocks %>% .$disqualification
tract_summary <- USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(STATEFP10, COUNTYFP10, TRACTCE10, disqualification) %>% 
  mutate(eligibility = ifelse(disqualification == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  select(-disqualification) %>% 
  group_by(STATEFP10, COUNTYFP10, TRACTCE10, eligibility) %>%
  summarise(sum = sum(n)) %>% 
  reshape2::dcast(STATEFP10 + COUNTYFP10 + TRACTCE10 ~ eligibility, sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(tract_summary$PERC_ELIGIBLE)
table(tract_summary$PERC_ELIGIBLE == 0) # FALSE = ELIGIBLE  # TRUE = INELIGIBLE
table(tract_summary$PERC_ELIGIBLE == 0)/nrow(tract_summary)

# saveRDS(tract_summary, paste0(savepath, "2018_tract_summary_cc_blockct_perc_elig", "_OCT21_2020", ".RDS"))

county_summary <- USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(STATEFP10, COUNTYFP10, disqualification) %>% 
  mutate(eligibility = ifelse(disqualification == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  select(-disqualification) %>% 
  group_by(STATEFP10, COUNTYFP10, eligibility) %>%
  summarise(sum = sum(n)) %>% 
  reshape2::dcast(STATEFP10 + COUNTYFP10 ~ eligibility, sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(county_summary$PERC_ELIGIBLE)
table(county_summary$PERC_ELIGIBLE == 0)
table(county_summary$PERC_ELIGIBLE == 0)/nrow(county_summary)  # FALSE = ELIGIBLE  # TRUE = INELIGIBLE

# saveRDS(county_summary, paste0(savepath, "2018_county_summary_cc_blockct_perc_elig", "_OCT21_2020", ".RDS"))

state_summary <- USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(STATEFP10, disqualification) %>% 
  mutate(eligibility = ifelse(disqualification == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  select(-disqualification) %>% 
  group_by(STATEFP10, eligibility) %>%
  summarise(sum = sum(n)) %>% 
  reshape2::dcast(STATEFP10 ~ eligibility, sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(state_summary$PERC_ELIGIBLE)
table(state_summary$PERC_ELIGIBLE == 0)
table(state_summary$PERC_ELIGIBLE == 0)/nrow(state_summary) # FALSE = ELIGIBLE # TRUE = INELIGIBLE

# saveRDS(state_summary, paste0(savepath, "2018_state_summary_cc_block_ct_perc_elig", "_OCT21_2020", ".RDS"))
```

```{r}
library(ggplot2)
state_summary<- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/2018_state_summary_cc_block_ct_perc_elig_SEPT23_2020.RDS")

state_summary <- state_summary %>% 
  left_join(fips_, by = c("STATEFP10" = "state_code"))
state_summary <- state_summary %>% 
  mutate(PERC_ELIGIBLE__ = paste0(100*(as.numeric(format(PERC_ELIGIBLE, digits = 1))), "%"))
ggplot(state_summary, aes(x = reorder(state, -PERC_ELIGIBLE), y = PERC_ELIGIBLE)) + 
  geom_bar(stat = "identity") + 
  geom_text(stat = "identity", aes(label = reorder(PERC_ELIGIBLE__, -PERC_ELIGIBLE), hjust=0.5, vjust = -1)) + 
  labs(title = "Percent Eligibility - States") + 
  xlab(label = "State Abbreviation") + 
  ylab(label = "Percent Eligibility (% by area)")
```


```{r perc_eligibility_byarea_cc}

tract_summary2 <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  mutate(eligibility = ifelse(disqualification == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  group_by(STATEFP10, COUNTYFP10, TRACTCE10, eligibility) %>% 
  summarise(area = as.numeric(blockarea))  %>%
  reshape2::dcast(STATEFP10 + COUNTYFP10 + TRACTCE10 ~ eligibility, value.var = "area", fun.aggregate = sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(tract_summary$PERC_ELIGIBLE)
table(tract_summary$PERC_ELIGIBLE == 0)
table(tract_summary$PERC_ELIGIBLE == 0)/nrow(tract_summary)  # FALSE = ELIGIBLE  # TRUE = INELIGIBLE



# saveRDS(tract_summary2, paste0(savepath, "2018_tract_summary_cc_area_perc_elig", "_OCT21_2020", ".RDS"))
```




```{r}
county_summary <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  mutate(eligibility = ifelse(disqualification == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  group_by(STATEFP10, COUNTYFP10, eligibility) %>% 
  summarise(area = as.numeric(blockarea))  %>%
  reshape2::dcast(STATEFP10 + COUNTYFP10 ~ eligibility, value.var = "area", fun.aggregate = sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(county_summary$PERC_ELIGIBLE)
table(county_summary$PERC_ELIGIBLE == 0)
table(county_summary$PERC_ELIGIBLE == 0)/nrow(county_summary)  # FALSE = ELIGIBLE  # TRUE = INELIGIBLE

saveRDS(county_summary, paste0(savepath, "2018_county_summary_cc_area_perc_elig", "_OCT21_2020", ".RDS"))

```


```{r}
state_summary <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  mutate(eligibility = ifelse(disqualification == "not disqual by speed/rural", "ELIGIBLE", "INELIGIBLE")) %>% 
  group_by(STATEFP10, eligibility) %>% 
  summarise(area = as.numeric(blockarea))  %>%
  reshape2::dcast(STATEFP10  ~ eligibility, value.var = "area", fun.aggregate = sum) %>% 
  mutate(Total = ELIGIBLE + INELIGIBLE, 
         PERC_ELIGIBLE = ELIGIBLE/Total, 
         PERC_ELIGIBLE_ = scales::percent(PERC_ELIGIBLE))

hist(state_summary$PERC_ELIGIBLE)
table(state_summary$PERC_ELIGIBLE == 0)
table(state_summary$PERC_ELIGIBLE == 0)/nrow(state_summary)  # FALSE = ELIGIBLE  # TRUE = INELIGIBLE

# saveRDS(state_summary, paste0(savepath, "2018_state_summary_cc_area_perc_elig", "_OCT21_2020", ".RDS"))
```


```{r}
library(ggplot2)
state_summary <- state_summary %>% 
  left_join(fips_, by = c("STATEFP10" = "state_code"))
state_summary <- state_summary %>% 
  mutate(PERC_ELIGIBLE__ = paste0(100*(as.numeric(format(PERC_ELIGIBLE, digits = 1))), "%"))
ggplot(state_summary, aes(x = reorder(state, -PERC_ELIGIBLE), y = PERC_ELIGIBLE)) + 
  geom_bar(stat = "identity") + 
  geom_text(stat = "identity", aes(label = reorder(PERC_ELIGIBLE__, -PERC_ELIGIBLE), hjust=0.5, vjust = -1)) + 
  labs(title = "Percent Eligibility - States") + 
  xlab(label = "State Abbreviation") + 
  ylab(label = "Percent Eligibility (% by area)")

```


```{r}
cc_areas <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RUS_CC_Shapefiles_April2020/CC 2013_2019_83 04272020.shp")

rc_areas <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RUS_RC_Shapefiles_April2020/ReConnect R1 594 PFSA 05012020.shp")


USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages//USA_2018_FULLCRITERIA_final_criteria_eligibility_23SEPT2020.RDS")


cc_areas <- cc_areas %>% st_transform(st_crs(USA_speed_rural_criteria_2018_censusblocks))
rc_areas <- rc_areas %>% st_transform(st_crs(USA_speed_rural_criteria_2018_censusblocks))


# BIP_tract_intersect should have the index of the shape from program_BIP for each Census tract in this example
# so to get the first BIP region each tract intersects with (NA if none), you can do
CC_block_intersect <- st_intersects(USA_speed_rural_criteria_2018_censusblocks, cc_areas)
CC_block_intersect_RUSIDs <- cc_areas$RUSID[ sapply(CC_block_intersect, first) ]

USA_speed_rural_criteria_2018_censusblocks <- USA_speed_rural_criteria_2018_censusblocks %>% mutate(blockarea = st_area(geometry), CC_RUSID_INTERSECT = CC_block_intersect_RUSIDs)

RC_block_intersect <- st_intersects(USA_speed_rural_criteria_2018_censusblocks, rc_areas)
RC_block_intersect_RUSIDs <- rc_areas$RUS_ID[ sapply(RC_block_intersect, first) ]

USA_speed_rural_criteria_2018_censusblocks <- USA_speed_rural_criteria_2018_censusblocks %>% mutate(RC_RUSID_INTERSECT = RC_block_intersect_RUSIDs)

# saveRDS(USA_speed_rural_criteria_2018_censusblocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/USA_2018_FULLCRITERIA_final_eligibility_CCRCflags_05OCT2020.RDS")

USA_speed_rural_criteria_2018_censusblocks <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/USA_2018_FULLCRITERIA_final_eligibility_CCRCflags_05OCT2020.RDS")

table(USA_speed_rural_criteria_2018_censusblocks$disqualification3)

table(USA_speed_rural_criteria_2018_censusblocks$CC_RUSID_INTERSECT)

USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(is.na(CC_RUSID_INTERSECT))

USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(is.na(RC_RUSID_INTERSECT))

USA_speed_rural_criteria_2018_censusblocks %>% as.data.frame() %>% count(is.na(RC_RUSID_INTERSECT))

#######################

cc_area_elig_summary1 <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  filter(!is.na(CC_RUSID_INTERSECT)) %>% 
  count(CC_RUSID_INTERSECT, disqualification3) 

cc_area_elig_summary1 <- cc_area_elig_summary1 %>% 
  mutate(eligibility = ifelse(disqualification3 %in% 
                    c("not disqual by speed/rural", "prot borr only", "caf2 only", "prot borr only + caf2"), 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(CC_RUSID_INTERSECT, eligibility) %>%
  summarise(totalblocks = sum(n)) %>%
  reshape2::dcast(CC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_BLOCKS = `1`/(`1`+`0`))

hist(cc_area_elig_summary1$perc_elig_BLOCKS)
mean(cc_area_elig_summary1$perc_elig_BLOCKS)

cc_area_elig_summary <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  filter(!is.na(CC_RUSID_INTERSECT)) %>% 
  group_by(CC_RUSID_INTERSECT, disqualification3) %>%
  summarise(area = sum(as.numeric(blockarea)))

cc_area_elig_summary <- cc_area_elig_summary %>% 
  mutate(eligibility = ifelse(disqualification3 %in% c("not disqual by speed/rural", "prot borr only", "caf2 only", "prot borr only + caf2"), 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(CC_RUSID_INTERSECT, eligibility) %>%
  summarise(area = sum(area)) %>%
  reshape2::dcast(CC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_AREA = `1`/(`1`+`0`))

hist(cc_area_elig_summary$perc_elig_AREA)
mean(cc_area_elig_summary$perc_elig_AREA)

#######################

rc_area_elig_summary1 <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  filter(!is.na(RC_RUSID_INTERSECT)) %>% 
  count(RC_RUSID_INTERSECT, disqualification3) 

rc_area_elig_summary1 <- rc_area_elig_summary1 %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(RC_RUSID_INTERSECT, eligibility) %>%
  summarise(totalblocks = sum(n)) %>%
  reshape2::dcast(RC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_BLOCKS = `1`/(`1`+`0`))

hist(rc_area_elig_summary1$perc_elig_BLOCKS)
mean(rc_area_elig_summary1$perc_elig_BLOCKS)

rc_area_elig_summary <- USA_speed_rural_criteria_2018_censusblocks %>% 
  as.data.frame() %>% 
  filter(!is.na(RC_RUSID_INTERSECT)) %>% 
  group_by(RC_RUSID_INTERSECT, disqualification3) %>%
  summarise(area = sum(as.numeric(blockarea)))

rc_area_elig_summary <- rc_area_elig_summary %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(RC_RUSID_INTERSECT, eligibility) %>%
  summarise(area = sum(area)) %>%
  reshape2::dcast(RC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_AREA = `1`/(`1`+`0`))

hist(rc_area_elig_summary$perc_elig_AREA)
mean(rc_area_elig_summary$perc_elig_AREA)

#######################

ccrc_blocks <- USA_speed_rural_criteria_2018_censusblocks %>% filter(!is.na(CC_RUSID_INTERSECT)|!is.na(RC_RUSID_INTERSECT))

ccyears <- cc_areas %>% transmute(RUSID, CC_OBLFY = OBLFY)
rcyears <- rc_areas %>% transmute(RUS_ID, RC_OBLFY =  Obligation)

st_geometry(ccrc_blocks) <- NULL
st_geometry(ccyears) <- NULL
st_geometry(rcyears) <- NULL

ccrc_blocks <- ccrc_blocks %>% 
  as.data.frame %>% 
  left_join(as.data.frame(ccyears), by = c("CC_RUSID_INTERSECT" = "RUSID"))  %>% 
  left_join(as.data.frame(rcyears), by = c("RC_RUSID_INTERSECT" = "RUS_ID"))
  
table(ccrc_blocks$CC_OBLFY)  
table(ccrc_blocks$RC_OBLFY)  

#######################

hist(cc_area_elig_summary1$perc_elig_BLOCKS)
hist(cc_area_elig_summary$perc_elig_AREA)
hist(rc_area_elig_summary1$perc_elig_BLOCKS)
hist(rc_area_elig_summary$perc_elig_AREA)

ccrc_blocks %>% 
  filter(CC_OBLFY == "2013") %>%
  .$RUSID %>% table

#######################
cc_area_elig_summary1_2013 <- ccrc_blocks %>% 
  filter(CC_OBLFY == "2013") %>% 
  count(CC_RUSID_INTERSECT, disqualification3) %>% 
  mutate(eligibility = ifelse(disqualification3 %in% c("not disqual by speed/rural", "prot borr only", "prot borr only", "caf2 only", "prot borr only + caf2"), 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(CC_RUSID_INTERSECT, eligibility) %>%
  summarise(totalblocks = sum(n)) %>%
  reshape2::dcast(CC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_BLOCKS = `1`/(`1`+`0`))

hist(cc_area_elig_summary1_2013$perc_elig_BLOCKS)
mean(cc_area_elig_summary1_2013$perc_elig_BLOCKS)

cc_area_elig_summary_2013 <- ccrc_blocks %>% 
  filter(CC_OBLFY == "2013") %>% 
  group_by(CC_RUSID_INTERSECT, disqualification3) %>%
  summarise(area = sum(as.numeric(blockarea))) %>%
  mutate(eligibility = ifelse(disqualification3 %in% c("not disqual by speed/rural", "prot borr only", "prot borr only", "caf2 only", "prot borr only + caf2"), 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(CC_RUSID_INTERSECT, eligibility) %>%
  summarise(area = sum(area)) %>%
  reshape2::dcast(CC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_AREA = `1`/(`1`+`0`))

hist(cc_area_elig_summary_2013$perc_elig_AREA)
mean(cc_area_elig_summary_2013$perc_elig_AREA)

#########
cc_area_elig_summary1_2014 <- ccrc_blocks %>% 
  filter(CC_OBLFY == "2014") %>% 
  count(CC_RUSID_INTERSECT, disqualification3) %>% 
  mutate(eligibility = ifelse(disqualification3 %in% c("not disqual by speed/rural", "prot borr only", "prot borr only", "caf2 only", "prot borr only + caf2"), 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(CC_RUSID_INTERSECT, eligibility) %>%
  summarise(totalblocks = sum(n)) %>%
  reshape2::dcast(CC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_BLOCKS = `1`/(`1`+`0`))

hist(cc_area_elig_summary1_2014$perc_elig_BLOCKS)
mean(cc_area_elig_summary1_2014$perc_elig_BLOCKS)

cc_area_elig_summary_2014 <- ccrc_blocks %>% 
  filter(CC_OBLFY == "2014") %>% 
  group_by(CC_RUSID_INTERSECT, disqualification3) %>%
  summarise(area = sum(as.numeric(blockarea))) %>%
  mutate(eligibility = ifelse(disqualification3 %in% c("not disqual by speed/rural", "prot borr only", "prot borr only", "caf2 only", "prot borr only + caf2"), 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(CC_RUSID_INTERSECT, eligibility) %>%
  summarise(area = sum(area)) %>%
  reshape2::dcast(CC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_AREA = `1`/(`1`+`0`))

hist(cc_area_elig_summary_2014$perc_elig_AREA)
mean(cc_area_elig_summary_2014$perc_elig_AREA)



#######################

rc_area_elig_summary1_2019 <- ccrc_blocks %>% 
  filter(RC_OBLFY == "2019") %>% 
  count(RC_RUSID_INTERSECT, disqualification3) %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(RC_RUSID_INTERSECT, eligibility) %>%
  summarise(totalblocks = sum(n)) %>%
  reshape2::dcast(RC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_BLOCKS = `1`/(`1`+`0`))

hist(rc_area_elig_summary1_2019$perc_elig_BLOCKS)

rc_area_elig_summary_2019 <- ccrc_blocks %>% 
  filter(RC_OBLFY == "2019") %>%  
  group_by(RC_RUSID_INTERSECT, disqualification3) %>%
  summarise(area = sum(as.numeric(blockarea)))  %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(RC_RUSID_INTERSECT, eligibility) %>%
  summarise(area = sum(area)) %>%
  reshape2::dcast(RC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_AREA = `1`/(`1`+`0`))

hist(rc_area_elig_summary_2019$perc_elig_AREA)

rc_area_elig_summary1_2019
rc_area_elig_summary_2019
####
rc_area_elig_summary1_2020 <- ccrc_blocks %>% 
  filter(RC_OBLFY == "2020") %>% 
  count(RC_RUSID_INTERSECT, disqualification3) %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(RC_RUSID_INTERSECT, eligibility) %>%
  summarise(totalblocks = sum(n)) %>%
  reshape2::dcast(RC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_BLOCKS = `1`/(`1`+`0`))

hist(rc_area_elig_summary1_2020$perc_elig_BLOCKS)
mean(rc_area_elig_summary1_2020$perc_elig_BLOCKS)

rc_area_elig_summary_2020 <- ccrc_blocks %>% 
  filter(RC_OBLFY == "2020") %>%  
  group_by(RC_RUSID_INTERSECT, disqualification3) %>%
  summarise(area = sum(as.numeric(blockarea)))  %>% 
  mutate(eligibility = ifelse(disqualification3 == "not disqual by speed/rural", 1, 0)) %>%
  select(-disqualification3) %>% 
  group_by(RC_RUSID_INTERSECT, eligibility) %>%
  summarise(area = sum(area)) %>%
  reshape2::dcast(RC_RUSID_INTERSECT ~ eligibility, sum) %>% 
  mutate(perc_elig_AREA = `1`/(`1`+`0`))

hist(rc_area_elig_summary_2020$perc_elig_AREA)
mean(rc_area_elig_summary_2020$perc_elig_AREA)





####




saveRDS(cc_area_elig_summary, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/allyears_cc_projectareas_perceligAREA.RDS")
# 2018_county_summary_area_perc_elig_SEPT23_2020.RDS
saveRDS(cc_area_elig_summary1, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/allyears_cc_projectareas_perceligBLOCKS.RDS")
saveRDS(rc_area_elig_summary, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/allyears_rc_projectareas_perceligAREA.RDS")
saveRDS(rc_area_elig_summary1, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/allyears_rc_projectareas_perceligBLOCKS.RDS")

saveRDS(ccrc_blocks, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/USA_2018_FULLCRITERIA_final_eligibility_CCRCflags_CCRCONLY_06OCT2020.RDS")


```



