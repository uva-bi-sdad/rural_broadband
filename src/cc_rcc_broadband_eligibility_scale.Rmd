---
title: "Eligibility - Rurality (Census) x Service (FCC)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE}
library(dplyr)
library(sf)
library(leaflet)
# setwd("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/")

```

```{r download_save_data, eval = FALSE}
urbanareas2017 <- tigris::urban_areas(year = "2017")
fips  <- tigris::fips_codes 
fips %>% filter(state_code == 74)

rm(i)
for (i in 57:nrow(fips_codes)) {
  print(i)
  # print(fips_codes[i,1])
  print(fips_codes[i,2])
  censusplaces2017_ <- tigris::places(state = fips_codes[i,1], year = "2017")
  name <- paste0("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/census_2017_urbanareas_places/census_2017_places_", fips_codes[i,1], ".RDS")
  saveRDS(censusplaces2017_, file = name)
  print(name)
}

# saveRDS(censusplaces2017_, paste0("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/census_2017_urbanareas_places/census_2017_places_", fips_codes[1,1], ".RDS"))

# saveRDS(urbanareas2017, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/census_2017_urbanareas.RDS")

```

Note: FCC Data is from https://www.fcc.gov/form-477-broadband-deployment-data-december-2017-version-2
Pulled: US - Fixed without Satellite - Dec 17v2 (CSV)

Rurality files - 2017 urban areas and census designated places

## Load data

1 - Census Areas 2017 (1 file) & Census Places 2017 (50+ files)


```{r}
## RURALITY 
path <- "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/census_2017_urbanareas_places/"
rurality_files <- list.files(path)
urbanareas2017 <- readRDS(paste0(path, rurality_files[57]))
rurality_files <- rurality_files[1:56]
rurality_files <- paste0(path, rurality_files)
data_l <- as.list(rurality_files)
shps <- lapply(data_l, function(x) readRDS(x))
shps_e <- do.call(rbind, shps)

head(shps_e)

## CENSUS

### clean environment
rm(rurality_files, data_l, shps)
```

## Load data

4 - Population data

```{r}
# Sys.setenv("ed8973afe8a22958b77ffdb8547c93c3cae1d2fc")
tidycensus::census_api_key("ed8973afe8a22958b77ffdb8547c93c3cae1d2fc") 
us_pop_2010 <- tidycensus::get_decennial(geography="place", variables="P001001", 
                                         year=2010,  cache_table=TRUE)

```

## Load data

2 - FCC 2017 data 
    - need to take highest speed available per block for AdDown and AdUp
    - need to calculate eligibility - if 10 AND 1 or higher on BOTH then INELIGIBLE if 10 OR 1 AND LOWER on either then eligible
3 - 2010 Census Block Shape file

## Join FCC availability & Block shapes


```{r}
## FCC
# fcc_2017 <- read.csv("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fbd_us_without_satellite_dec2017_v2.csv")
# saveRDS(fcc_2017, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fbd_us_without_satellite_dec2017_v2.RDS")
# fcc_2017 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fbd_us_without_satellite_dec2017_v2.RDS") ##This is the original data, summarized it below with max speed per block

# fcc_2017_block_access <- fcc_2017 %>%
#   group_by(StateAbbr, BlockCode) %>%
#   summarise(MaxAdDown_ = max(MaxAdDown),
#             MaxAdUp_ = max(MaxAdUp)) %>%
#   mutate(speed_elig_down = ifelse(MaxAdDown_ >= 10, 0, 1),
#          speed_elig_up = ifelse(MaxAdUp_ >= 1, 0, 1),
#          speed_inelig = ifelse(MaxAdDown_ >= 10 & MaxAdUp_ >= 1, 1, 0),
#          speed_elig = ifelse(MaxAdDown_ >= 10 & MaxAdUp_ >= 1, 0, 1))

# saveRDS(fcc_2017_block_access, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fcc_2017_block_maxspdelig.RDS")

fcc_2017_block_access <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fcc_2017_block_maxspdelig.RDS")

# state_blocks <- fcc_2017_block_access %>% count(StateAbbr)

```


```{r}
fips  <- tigris::fips_codes 
fips_ <- fips %>% select(state, state_code) %>% distinct()

# geo_folder <- "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS/"
# geo_paths <- list.files(geo_folder)
# 
# geo_paths <- data.frame(files = geo_paths) %>% mutate(state = stringr::str_remove_all(files, "tl_2018_|_tabblock10.RDS$"))
# 
# geo_paths <- geo_paths %>% 
#   left_join(fips_, by = c("state" = "state_code")) %>% 
#   transmute(state = state.y, state_fips = state, files, paths = paste0(geo_folder, files))
# 
# data_l <- as.list(geo_paths$paths)
# shapes <- lapply(data_l, function(x) readRDS(x))
# shapes_e <- do.call(rbind, shapes)

# saveRDS(shapes, "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_LIST.RDS")

shapes <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_LIST.RDS")

# saveRDS(shapes_e, "/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_SF.RDS")

shapes_e  <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS_USA_SF.RDS")

```


```{r}

# shapes_e %>% 
# fcc_2017_block_access$BlockCode <- as.character(fcc_2017_block_access$BlockCode)
# 
# shapes_fcc <- list()
# 
# for (i in 1:length(shapes)) {
#   print(i)
#   shapes_fcc[[i]] <- shapes[[i]] %>% left_join(fcc_2017_block_access, by = c("GEOID10" = "BlockCode")) 
# }
# 
# shapes_fcc[[1]] %>% count(speed_elig)
# unique(shapes_fcc[[3]]$speed_elig)
# fcc_2017_block_access

```

```{r}
fcc_2017_block_access$BlockCode <- as.character(fcc_2017_block_access$BlockCode)
fcc_2017_block_access <- fcc_2017_block_access %>% mutate(BlockCode2 = ifelse(nchar(BlockCode) == 14, paste0("0", BlockCode), BlockCode))

shapes_e_fcc <- shapes_e %>% 
  mutate(FULL_GEOID = paste0(STATEFP10, COUNTYFP10, TRACTCE10, BLOCKCE10)) %>% 
  left_join(fcc_2017_block_access, by = c("FULL_GEOID" = "BlockCode2")) %>% 
  left_join(fips_, by = c("STATEFP10" = "state_code"))

joinbystate_res <- shapes_e_fcc %>% as.data.frame() %>% count(state, speed_elig)
fcccehckbystate_res <- fcc_2017_block_access %>% count(StateAbbr, speed_elig) 

joinbystate_res %>% select(-n) %>% count(state) 
fcccehckbystate_res
```



```{r}

fcc_2017_VA <- fcc_2017_block_access %>% filter(StateAbbr == "VA")

va_blocks_2018 <- readRDS("/project/biocomplexity/sdad/projects_data/usda/bb/original/censusblocks/blocks_TIGER2018_sf_RDS/tl_2018_51_tabblock10.RDS")
va_blocks_2018 <- va_blocks_2018 %>% mutate(FULL_GEOID = paste0(STATEFP10, COUNTYFP10, TRACTCE10, BLOCKCE10))
fcc_2017_VA$BlockCode <- as.character(fcc_2017_VA$BlockCode)

fcc_2017_VA <- va_blocks_2018 %>% inner_join(fcc_2017_VA, by = c("FULL_GEOID" = "BlockCode")) 

# test_fcc <- fcc_2017_VA %>% filter(speed_elig == 1)
# table(fcc_2017_VA$speed_elig)
# table(fcc_2017_VA$speed_elig)/nrow(fcc_2017_VA)
# plot(test_fcc$geometry)

# plot_elig <- fcc_2017_VA %>% filter(speed_elig == 1)
# plot_elig <- plot_elig %>% st_transform(st_crs(4326))

# fcc_2017_VA %>% as.data.frame() %>% select(MaxAdDown_, MaxAdUp_, speed_inelig, speed_elig) %>% filter(speed_elig == 0)
# fcc_2017_VA %>% as.data.frame() %>% filter(MaxAdDown_ == 10) 
# fcc_2017_block_access %>% as.data.frame() %>% filter(MaxAdDown_ == 13) 
```


## Filter rurality datasets to Virginia

```{r}
rurality_va <- shps_e %>% filter(STATEFP == "51")

urbanareas2017 <- urbanareas2017 %>% mutate(state = stringr::str_extract(NAME10, ".{2}$") )
urbanareas2017_va <- urbanareas2017 %>% filter(state == "VA")

rurality_va_ <- rbind(rurality_va %>% 
                        transmute(SET = "places", GEOID10 = GEOID, 
                                  NAME10 = NAME, NAMELSAD10 = NAMELSAD, 
                                  LSAD10 = LSAD, geometry), 
                      urbanareas2017_va %>% 
                        transmute(SET = "areas", GEOID10, NAME10, 
                                  NAMELSAD10, LSAD10, geometry))

rurality_va_ <- rurality_va_ %>% left_join(va_pop_2010, by = c("GEOID10" = "GEOID"))

rurality_va_elig_dontuse <- rurality_va_ %>% filter(value < 20000)
rurality_va_inelig <- rurality_va_ %>% filter(SET == "areas" | value >= 20000)

```

## Here is Virginia rurality plotted

1. orange = census places
2. red = census areas

```{r}
va_counties <- tigris::counties(state = "51")
```


```{r}
# so you can see what was there before removing 20K
leaflet(va_counties) %>%  
  addTiles() %>%
  addPolygons(stroke = 0, fillOpacity = 0.2, color = "#808080") %>% 
  addPolygons(data = rurality_va_, stroke = 0, fillOpacity = .5, color = "#ffb30f") %>%
  addPolygons(data = urbanareas2017_va, stroke = 0, fillOpacity = .8, color = "#d12115")


# so you can see places vs. areas 
leaflet(va_counties) %>%  
  addTiles() %>%
  addPolygons(stroke = 0, fillOpacity = 0.2, color = "#808080") %>% 
  addPolygons(data = rurality_va_inelig, stroke = 0, fillOpacity = .5, color = "#ffb30f") %>%
  addPolygons(data = urbanareas2017_va, stroke = 0, fillOpacity = .8, color = "#d12115")

#places and areas in same color
leaflet(va_counties) %>%  
  addTiles() %>%
  addPolygons(stroke = 0, fillOpacity = 0.2, color = "#808080") %>% 
  addPolygons(data = rurality_va_inelig, stroke = 0, fillOpacity = .5, color = "#ffb30f") 
```

```{r eval = FALSE}
rurality_va_elig_dontuse %>% filter(stringr::str_detect(NAME10, "Falls|Vienna|Wolf"))
```

```{r}
ffx_fcc <- fcc_2017_VA %>% filter(COUNTYFP10 == "059")
ffx_fcc
pal2 <- colorFactor("RdYlBu", ffx_fcc$speed_elig)
```


```{r}
# 
leaflet(va_counties %>% filter(COUNTYFP == "059")) %>%  
  addTiles() %>%
  addPolygons(stroke = 0, fillOpacity = 0.2, color = "#808080") %>% 
  addPolygons(data = ffx_fcc, stroke = 0, fillOpacity = .5, color = ~pal2(speed_elig)) #%>%
  # addPolygons(data = urbanareas2017_va, stroke = 0, fillOpacity = .8, color = "#d12115")
```

```{r}
fcc_2017_VA_inelig <- fcc_2017_VA %>% filter(speed_inelig == 1)

fcc_2017_VA_inelig %>% head()
rurality_va_inelig %>% head()


va_ineligibility <- rbind(fcc_2017_VA_inelig %>%  transmute(GEOID10, NAME10, geometry, SET = "FCC"),
      rurality_va_inelig %>% transmute(GEOID10, NAME10, geometry, SET = "POP") ) 
```



```{r}

# va_inlig_intersection <- st_intersection(fcc_2017_VA_inelig, rurality_va_)  %>% 
#   mutate(geo =st_geometry_type(geometry)) #%>% filter(stringr::str_detect(geo, "POLYG"))
# saveRDS(va_ineligibility, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/va_ineligibility_18AUG2020.RDS")
va_ineligibility <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/va_ineligibility_18AUG2020.RDS")

ffx <- va_ineligibility %>% filter(stringr::str_detect(GEOID10, "^51059"))
ffx_union <- st_union(ffx)
# va_ineligibility_union <- st_union(va_ineligibility)  # DO NOT RUN, will crash 

leaflet(ffx_union) %>%
  addTiles() %>%
  addPolygons(stroke = 0, fillOpacity = .5, color = "#ED190E") 





```


```{r}

library(dplyr)
va_ineligibility <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/va_ineligibility_18AUG2020.RDS")

us_states <- tigris::states()
va_outline <- us_states %>% filter(STATEFP == "51")

test_va_elig <- sf::st_difference(va_outline, va_ineligibility)



```




```{r}
ffx_1 <- st_union(ffx)

# ffx_2 <- st_combine(ffx)

leaflet(ffx_1) %>%
  addTiles() %>% 
  addPolygons(stroke = 0, fillOpacity = .5, color = "#4287f5")

# leaflet(ffx_2) %>%
#   addTiles() %>% 
#   addPolygons(stroke = 0, fillOpacity = .5, color = "#4287f5")



# plot(va_outline$geometry)
test_va_elig <- sf::st_difference(va_outline, ffx_1)

leaflet(test_va_elig) %>%
  addTiles() %>% 
  addPolygons(stroke = 0, fillOpacity = .5, color = "#4287f5")


```

```{r}
length(unique(va_intersection$COUNTYFP10))

county_fips <- unique(va_intersection$COUNTYFP10)
for (i in 1:length(unique(va_intersection$COUNTYFP10))) {
  
}
```


